# Default OS image is Ubuntu 12.04 LTS Precise on Travis-CI for linux
language: c

os:
  - linux

compiler:
  - gcc

env:
  - FEATURES=huge SRCDIR=vim/src
    "CONFOPT='--enable-gui=gtk2 --enable-perlinterp --enable-pythoninterp --enable-python3interp --enable-rubyinterp --enable-luainterp --enable-tclinterp --prefix=/usr'"

# sudo required to build AppImage (does apparently enable FUSE extensions)
sudo: required

branches:
  except:
    - /^v[0-9]/

addons:
  apt:
    sources:
      # Need msgfmt 0.19.8 to be able to generate .desktop files
      - sourceline: 'ppa:ricotz/toolchain'
    packages:
      - autoconf
      - clang
      - lcov
      - gettext
      - libperl-dev
      - python-dev
      - python3-dev
      - liblua5.2-dev
      - lua5.2
      - ruby-dev
      - tcl-dev
      - cscope
      - libgtk2.0-dev

before_install:
    # make sure to use default 1.9.3 ruby (switching sudo on, does add different ruby versions, GRR!)
  - rvm use 1.9.3 --install --binary --fuzzy

script:
  - NPROC=$(getconf _NPROCESSORS_ONLN)
  - (cd ${SRCDIR} && ./configure --with-features=$FEATURES $CONFOPT --enable-fail-if-missing &&  make -j$NPROC )
  - ${SRCDIR}/vim --version

after_success:
  - bash -ex scripts/appimage.sh || true

before_deploy:
  # Set up git user name and tag this commit
  - git config --local user.name "TRAVIS-BUILD"
  - git config --local user.email "TRAVIS-BUILD"
  - export TRAVIS_TAG=$(cd vim && git describe --tags --abbrev=0)
  - git tag -f $TRAVIS_TAG
  - RELEASE_BODY="$(cat $TRAVIS_BUILD_DIR/release.body)"

deploy:
  - provider: releases
    api-key: $API_TOKEN
    file: "*.AppImage"
    file_glob: true
    body: "$RELEASE_BODY"
    skip_cleanup: true
    #  on:
    #  tags: true

# vim:set sts=2 sw=2 tw=0 et:
